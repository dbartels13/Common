<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sphyrnidae Common Library: Email</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Sphyrnidae Common Library
   &#160;<span id="projectnumber">2.0.1</span>
   </div>
   <div id="projectbrief">Shared Utilities/Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_email_md.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Email </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_C__Users_dougb_Desktop_Sphyrnidae_New_Common_Common_EmailUtilities_Email"></a> </p>
<h1><a class="anchor" id="EmailOverviewMd"></a>
Overview</h1>
<p>Sending an email is the purpose of the <a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email.html">IEmail</a> interface. To access this, you should likely utilize the <a class="el" href="class_sphyrnidae_1_1_common_1_1_email_utilities_1_1_email.html">wrapper</a> as this allows for lots of overloads against the interface. There is only 1 method on the interface, so your chosen implementation could be as simple as you'd like. However, we recommend a great deal of configurability which is present in our implementation (and is easily applied to your custom implementation).</p>
<p>Interface: <a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email.html">IEmail</a></p>
<p>Mock: <a class="el" href="class_sphyrnidae_1_1_common_1_1_email_utilities_1_1_email_mock.html">EmailMock</a></p>
<p>Wrapper: <a class="el" href="class_sphyrnidae_1_1_common_1_1_email_utilities_1_1_email.html">Email</a></p>
<p>Implementations:</p><ol type="1">
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_email_utilities_1_1_email_mock.html">EmailMock</a>: Registered implementation which does nothing</li>
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_email_utilities_1_1_dot_net_email.html">DotNetEmail</a>: Sends emails using standard .Net mechanism. This requires additional interface implementations/registrations, but is also very configurable. See <a class="el" href="_email_md.html#EmailImplementationMd">Implementation Customizations</a></li>
</ol>
<h1><a class="anchor" id="EmailImplementationMd"></a>
Implementation Customizations</h1>
<p>The <a class="el" href="class_sphyrnidae_1_1_common_1_1_email_utilities_1_1_dot_net_email.html">DotNetEmail</a> is very configurable. There are many principles at work here, so we'll start with the <a class="el" href="namespace_sphyrnidae_1_1_common_1_1_email_utilities_1_1_models.html#a906a7d0a948cce173dd2cb78f80fe718">EmailType</a>. This implementation also makes use of <a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html">IEmailSettings</a> and <a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_dot_net_email_settings.html">IDotNetEmailSettings</a>. An email is generally made up of the following pieces of information:</p><ol type="1">
<li>From (email)</li>
<li>From (display name)</li>
<li>To</li>
<li>CC</li>
<li>BCC</li>
<li>Subject</li>
<li>Body</li>
</ol>
<p>3-7 are provided via the interface (will be up to the consumer of this interface to specify all of these). It should be up to your implementation to fill in 1-2, make any changes to the others, format the body, and actually send the message.</p>
<h2>Email Types</h2>
<p>Knowing the <a class="el" href="namespace_sphyrnidae_1_1_common_1_1_email_utilities_1_1_models.html#a906a7d0a948cce173dd2cb78f80fe718">type</a> of email, allows you to hard-code certain things. These "things", in the implementation, are the actual listing of recipients (eg. To). This allows you to have a configurable list of recipients per email type.</p>
<h2>Email Settings</h2>
<p>The <a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html">IEmailSettings</a> interface allows for all of the customizations. There are several "Recipients" properties that will be the "To" listing of email address matching up with the corresponding <a class="el" href="namespace_sphyrnidae_1_1_common_1_1_email_utilities_1_1_models.html#a906a7d0a948cce173dd2cb78f80fe718">type</a>: </p><table class="doxtable">
<tr>
<th><a class="el" href="namespace_sphyrnidae_1_1_common_1_1_email_utilities_1_1_models.html#a906a7d0a948cce173dd2cb78f80fe718">Email Type</a> </th><th>Property </th></tr>
<tr>
<td><a class="el" href="namespace_sphyrnidae_1_1_common_1_1_email_utilities_1_1_models.html#a906a7d0a948cce173dd2cb78f80fe718ab0d4998a26f5b5742ad38c4af8817e32">Exception</a> </td><td><a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html#ad156a9deecdf4c1bb616f25656888487">ExceptionsRecipients</a> </td></tr>
<tr>
<td><a class="el" href="namespace_sphyrnidae_1_1_common_1_1_email_utilities_1_1_models.html#a906a7d0a948cce173dd2cb78f80fe718a197e128b8cf3accf46a996f3af0c67da">HiddenException</a> </td><td><a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html#abb13207b4d0b815ec0523cab23eccbdc">HiddenExceptionRecipients</a> </td></tr>
<tr>
<td><a class="el" href="namespace_sphyrnidae_1_1_common_1_1_email_utilities_1_1_models.html#a906a7d0a948cce173dd2cb78f80fe718a8db7df66ab1d7ab5f1dc947acdb5fae4">Logging</a> </td><td><a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html#abf21f06dae85c53ce9d8b6f0bec3eef9">LoggingRecipients</a> </td></tr>
<tr>
<td><a class="el" href="namespace_sphyrnidae_1_1_common_1_1_email_utilities_1_1_models.html#a906a7d0a948cce173dd2cb78f80fe718a9112235e18c71054932ef98d06ef03da">LongRunning</a> </td><td><a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html#ad1a268685d0186e8c2b8cc2afb404cdf">LongRunningRecipients</a> </td></tr>
<tr>
<td><a class="el" href="namespace_sphyrnidae_1_1_common_1_1_email_utilities_1_1_models.html#a906a7d0a948cce173dd2cb78f80fe718a74ffdfbd140f9a6e5d6a12c390f3c49a">HttpFailure</a> </td><td><a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html#ae336995ac1575788ffca02d18703971f">HttpFailureRecipients</a> </td></tr>
<tr>
<td><a class="el" href="namespace_sphyrnidae_1_1_common_1_1_email_utilities_1_1_models.html#a906a7d0a948cce173dd2cb78f80fe718a90589c47f06eb971d548591f23c285af">Custom</a> </td><td>User-supplied during the call </td></tr>
</table>
<p>Redirects are the ability to change who the email is being sent to (or cc/bcc). A redirect could happen for any number of reasons, but the most common scenario is environment-specific. In a non-production environment, you want to make sure that emails are not actually being sent out to end-users. You can guard against this by having the following configurations retrieve their values from the <a class="el" href="_environment_md.html">environment</a> or from <a class="el" href="_variable_md.html">variables</a>.</p><ol type="1">
<li><a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html#a2b01fc107ee96309852c8793b025956c">AllowRedirect</a>: This should be false for production, but probably set to true for other environments. If this value is false, the remaining properties will be ignored. If this value is true, you will need to ensure the remaining properties are properly configured.</li>
<li><a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html#adfa80940236d01ac31576e6aa93a019a">AllowedDomains</a>: This is a white-listing of domains (eg. sphyrnidaetech.com) where emails will go out normally. Anything that is not listed, will be redirected. The domains listed are not wild-carded. The exact phrase must match the ending of the provided email address to be allowed.</li>
<li><a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html#a846c51dc0553e8ec517bf9d022033e1a">DomainAndEmailComparison</a>: This allows you to customize the behavior (eg. InvariantCultureIgnoreCase) for pattern matching the email address/domains.</li>
<li><a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html#aee6735b466538849f1ebad3ce175aa40">RedirectRecipients</a>: If an email address is not white-listed, this property will specify who will get the email instead (eg. send to your development/qa team).</li>
<li><a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html#ad59ef9656d0c56d9bf3f1ba32c5eac71">ShowRedirectedRecipients</a>: If an email address has been removed, setting this property will append this information to the end of the email (eg. will tell you whom should have received this were it not for redirects).</li>
</ol>
<p>The remaining properties will also need to be filled in:</p><ol type="1">
<li><a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html#aa66a8ed3c909d0667d1e73414c005604">Bcc</a>: If you always wish to BCC an account, you can set this. This can be useful for ensuring that emails are actually being sent and that email account can contain the full record of all emails in the system.</li>
<li><a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html#af90bae91c49a8bb6b2d426e7a45100dc">FromEmail</a>: The email address of the sender of all system emails (eg. <a href="#" onclick="location.href='mai'+'lto:'+'nor'+'ep'+'ly@'+'sp'+'hyr'+'ni'+'dae'+'te'+'ch.'+'co'+'m'; return false;">norep<span style="display: none;">.nosp@m.</span>ly@s<span style="display: none;">.nosp@m.</span>phyrn<span style="display: none;">.nosp@m.</span>idae<span style="display: none;">.nosp@m.</span>tech.<span style="display: none;">.nosp@m.</span>com</a>).</li>
<li><a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_settings.html#a5d654162519b2a700af2ec51a2736b08">FromName</a>: The display name for the 'from' email (eg. The name of your company).</li>
</ol>
<p>In my implementations, I have these filled in by another interface implementation: <a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_email_default_settings.html">IEmailDefaultSettings</a></p>
<h2>Dot Net Settings</h2>
<p>The last piece of configurability is specific to the <a class="el" href="class_sphyrnidae_1_1_common_1_1_email_utilities_1_1_dot_net_email.html">DotNetEmail</a> implementation. This implementation uses the <a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_dot_net_email_settings.html">IDotNetEmailSettings</a> to specify customizations that are specific for sending emails in .Net. Hopefully these properties are self-explanatory, and please note the <a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_dot_net_email_settings.html#a2ee5893458a720cafbe40576e98b94cd">Password</a> property is <a class="el" href="_encryption_md.html">encrypted</a>.</p>
<h1><a class="anchor" id="EmailCustomMd"></a>
Custom Implementation</h1>
<p>If you are developing your own implementation of sending emails, you may wish to utilize this same type of behavior. The EmailHelper class can help apply all of these behaviors to your interface implementation. From there, it will be your responsibility in your implementation to take everything from the EmailItems and put this data into your email object.</p>
<h1><a class="anchor" id="EmailWhereUsedMd"></a>
Where Used</h1>
<ol type="1">
<li><a class="el" href="_signal_r_md.html">SingalR</a>: Errors will be emailed</li>
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_email_utilities_1_1_email_base.html">EmailBase</a>: How to send the customized email content</li>
<li>Logger: Any failures during logging will be emailed</li>
<li><a class="el" href="_settings_md.html">Settings</a>: Any errors retrieving these listings will be emailed</li>
</ol>
<h1><a class="anchor" id="EmailExampleMd"></a>
Examples</h1>
<pre>
    public class DotNetEmail : IEmail
    {
        private IEmailSettings Settings { get; }
        private IDotNetEmailSettings DotNetSettings { get; }
        private IEncryption Encryption { get; }
        public DotNetEmail(IEmailSettings settings, IDotNetEmailSettings dotNetSettings, IEncryption encryption)
        {
            Settings = settings;
            DotNetSettings = dotNetSettings;
            Encryption = encryption;
        }

        public async Task&lt;bool&gt; SendAsync(EmailType type, IEnumerable&lt;string&gt; to, IEnumerable&lt;string&gt; cc, string subject, string content)
        {
            var emailInformation = EmailHelper.ToEmailItems(Settings, type, to, cc, subject, content);

            var msg = new MailMessage
            {
                From = new MailAddress(emailInformation.FromEmail, emailInformation.FromName),
                Subject = emailInformation.Subject
            };

            foreach (var email in emailInformation.To)
                msg.To.Add(new MailAddress(email));
            foreach (var email in emailInformation.Cc)
                msg.CC.Add(new MailAddress(email));
            foreach (var email in emailInformation.Bcc)
                msg.Bcc.Add(new MailAddress(email));

            msg.AlternateViews.Add(AlternateView.CreateAlternateViewFromString(emailInformation.Body, null, MediaTypeNames.Text.Plain));
            msg.AlternateViews.Add(AlternateView.CreateAlternateViewFromString(emailInformation.Body.ToHtml(), null, MediaTypeNames.Text.Html));

            using var client = new SmtpClient
            {
                DeliveryMethod = SmtpDeliveryMethod.Network,
                EnableSsl = DotNetSettings.EnableSsl
            };

            var host = DotNetSettings.Host;
            if (!string.IsNullOrWhiteSpace(host))
                client.Host = host;

            var port = DotNetSettings.Port;
            if (port.HasValue &amp;&amp; port.Value != 0)
                client.Port = port.Value;

            var password = DotNetSettings.Password;
            if (!string.IsNullOrWhiteSpace(password))
            {
                client.UseDefaultCredentials = false;
                var decrypted = password.Decrypt(Encryption).Value;
                client.Credentials = new NetworkCredential(emailInformation.FromEmail, decrypted);
            }

            // Must leave as try/catch because the client would otherwise be disposed and not captured
            try
            {
                await client.SendMailAsync(msg);
                return true;
            }
            catch (Exception ex)
            {
                return false;
            }
        }
    }
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
