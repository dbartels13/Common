<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sphyrnidae Common Library: API Methods</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Sphyrnidae Common Library
   &#160;<span id="projectnumber">2.0.1</span>
   </div>
   <div id="projectbrief">Shared Utilities/Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_api_md.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">API Methods </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_C__Users_dougb_Desktop_Sphyrnidae_New_Common_Common_Api_Api"></a> </p>
<h1><a class="anchor" id="ApiPipelineMd"></a>
Pipeline / Middleware</h1>
<p>The <a class="el" href="namespace_sphyrnidae_1_1_common_1_1_api.html">Sphyrnidae.Common.Api</a> namespace is mostly about building a robust pipeline for a modern WebAPI. This namespace is driven by the <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_service_registration_1_1_models_1_1_service_configuration.html">ServiceConfiguration</a> class. It comes pre-configured to do all of the following things: </p><ul>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_service_registration_1_1_cors_helper.html">Cors</a> </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_service_registration_1_1_swagger_helper.html">Swagger</a> </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_service_registration_1_1_health_check_helper.html">Health Checks</a> </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_service_registration_1_1_cache_helper.html">Caching</a> </li>
<li>
Web Services (enabled by default) </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_service_registration_1_1_api_helper.html">API Configurations</a> </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_service_registration_1_1_signal_r_helper.html">SignalR</a> </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_service_registration_1_1_pipeline_helper.html">Pipeline</a> </li>
</ul>
<p>The default pipeline used in the configuration is: </p><ol>
<li>
DevelopmentHsts - Dev/Localhost: app.UseDeveloperExceptionPage(); Other: app.UseHsts(); </li>
<li>
HttpsRedirect - app.UseHttpsRedirection(); </li>
<li>
Swagger - Enable swagger/UI (app.UseSwagger(); app.UseSwaggerUI();) </li>
<li>
Routing - app.UseRouting(); </li>
<li>
Cors - app.UseCors(config.CorsPolicyName); </li>
<li>
HealthCheck - app.UseHealthChecks(config.HealthCheckEndpoint, config.HealthCheckOptions(envSettings)); </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_http_data_middleware.html">HttpData</a> </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_authentication_middleware.html">Authentication</a> </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_jwt_middleware.html">JWT</a> </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_exception_middleware.html">Exceptions</a> </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_api_logging_middleware.html">Logging</a> </li>
<li>
Controller API Call - app.UseEndpoints(endpoints =&gt; {endpoints.MapControllers();}); </li>
</ol>
<p>You can create/add any additional middleware components you want to this pipeline, or totally redo the pipeline.</p>
<h1><a class="anchor" id="ApiServiceRegistrationMd"></a>
Service Registration</h1>
<p>In your own application, you need only worry about things that are specific to your application. However, you do need to wire in all of this configuration into your startup.cs class. Information on doing this is given in <a class="el" href="_setup_md.html">API Setup</a>.</p>
<h1><a class="anchor" id="ApiAttributesMd"></a>
Attributes</h1>
<p>There are a number of <a class="el" href="namespace_sphyrnidae_1_1_common_1_1_api_1_1_attributes.html">Attributes</a>. There are 2 types of attributes: </p><ol>
<li>
Validation Attributes: <ol>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_attributes_1_1_enum_validator_attribute.html">EnumValidator</a> </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_attributes_1_1_not_default_attribute.html">NotDefault</a> </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_attributes_1_1_reg_ex_attribute.html">RegEx</a> </li>
</ol>
</li>
<li>
Pipeline configuration attributes: <ol>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_attributes_1_1_authentication_attribute.html">Authentication</a> </li>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_attributes_1_1_skip_log_attribute.html">SkipLog</a> </li>
</ol>
</li>
</ol>
<h1><a class="anchor" id="AuthenticationMiddlewareMd"></a>
Authentication</h1>
<p>The <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_authentication_middleware.html">Authentication</a> middleware component take care of Authentication and Authorization checks. If your API endpoint needs to be secured, you should put the <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_attributes_1_1_authentication_attribute.html">Authentication</a> attribute on it. This attribute has one of the following <a class="el" href="namespace_sphyrnidae_1_1_common_1_1_api_1_1_models.html#ae9cb39820839b92e308c33c448f8ddbf">types</a>: </p><ol>
<li>
None: Use this type if you have specified the entire controller should be secured, but not this particular endpoint. If an authenticated user accesses this endpoint, that will be allowed. If an unauthenticated user access this endpoint, they will be assigned the <a class="el" href="interface_sphyrnidae_1_1_common_1_1_authentication_1_1_helper_1_1_i_identity_helper.html">default/public identity</a>: see GetDefaultIdentity() method </li>
<li>
Jwt: This is the primary mechanism for authentication. To learn more about JWT's, go <a href="https://en.wikipedia.org/wiki/JSON_Web_Token" target="blank">here</a> </li>
<li>
ApiToApi: Microservice calls will provide their authorization "key" to the next service. Using this type ensures that this endpoint is hit only by a validated microservice call. </li>
</ol>
<p>The JWT is basically a serialized and encrypted <a class="el" href="class_sphyrnidae_1_1_common_1_1_authentication_1_1_identity_1_1_base_identity.html">Identity Object</a> - generated and decrypted using the <a class="el" href="interface_sphyrnidae_1_1_common_1_1_authentication_1_1_helper_1_1_i_identity_helper.html">IIdentityHelper</a>.</p>
<p>The JWT contains a collection of roles (List&lt;string&gt;) that the user has access to. By specifying a named role in the <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_attributes_1_1_authentication_attribute.html">Authentication</a> attribute, this will first Authenticate via the JWT, and then Authorize based on the user having that named role in their role collection.</p>
<p>The <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_jwt_middleware.html">JWT</a> middleware component does not play a direct role in Authentication/Authorization. What this component does instead is places a <a class="el" href="_authentication_md.html#AuthenticationRefreshTokenMd">refreshed JWT</a> into the <a class="el" href="interface_sphyrnidae_1_1_common_1_1_http_client_1_1_i_http_client_settings.html#a35a499933e297cd1de730dab35902bdb">Authorization</a> header of the HTTP Response. If there were any updates to the <a class="el" href="class_sphyrnidae_1_1_common_1_1_authentication_1_1_identity_1_1_base_identity.html">Identity Object</a>, you will need to update the <a class="el" href="interface_sphyrnidae_1_1_common_1_1_authentication_1_1_helper_1_1_i_identity_helper.html#a9fff16512e12a6fefa3bd91b655fabe3">Current</a> object with this updated/new identity.</p>
<p>For more information on Authentication and Authorization, go <a class="el" href="_authentication_md.html">here</a></p>
<h1><a class="anchor" id="ApiResponseMd"></a>
Responses</h1>
<p>In your business logic, you may need to return a non-2xx response. If you are in the controller, you have access to methods such as Ok() or NotFound(). However, in other layers, you don't have access to these methods. Instead, you should be returning a business entity and relying on the controller to actually convert that entity into a response object. I have created a class called <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_responses_1_1_api_response_standard.html">ApiResponseStandard</a> which serves that purpose.</p>
<p><a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_responses_1_1_api_response_standard.html">ApiResponseStandard</a> is the business entity that contains all the information needed for a controller to convert this to an HTTP response. To create an <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_responses_1_1_api_response_standard.html">ApiResponseStandard</a>, you can use the static methods contained in <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_responses_1_1_api_response.html">ApiResponse</a>.</p>
<p>When this object is returned to the controller, you can execute one of the <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_base_classes_1_1_base_api.html">base class</a> methods. The <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_base_classes_1_1_base_api.html">BaseApi</a> class takes as a constructor argument <a class="el" href="interface_sphyrnidae_1_1_common_1_1_api_1_1_responses_1_1_i_api_response.html">IApiResponse</a>. This class is injected, and by calling the methods FormatResponse() or GetWithDefaultsRemoved(), this will create the proper response from the <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_responses_1_1_api_response_standard.html">ApiResponseStandard</a> object. By default, the registered implementation of <a class="el" href="interface_sphyrnidae_1_1_common_1_1_api_1_1_responses_1_1_i_api_response.html">IApiResponse</a> is <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_responses_1_1_api_response_standard.html">ApiResponseStandard</a>. If you'd like to format the HTTP response differently, you can register a new implementation. The common scenario I've seen for this is when you're trying to differentiate between a network 404 and a server/application 404.</p>
<p>Additionally, if you have a customized HTTP response object (eg. not just the simple return object in the body of the response), you will need to update ModelState validation. This will be done by registering a new <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_service_registration_1_1_models_1_1_service_configuration.html#a651583db216d376b2be46cfc2c7111af">ApiControllerConfiguration</a>. Your custom implementation will be registered with the builder as builder.ConfigureApiBehaviorOptions(YOUR_METHOD), and to override the ModelState validation error, you should specify a custom implementation for InvalidModelStateResponseFactory.</p>
<h1><a class="anchor" id="ApiExceptionsMd"></a>
Error Handling</h1>
<p>The <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_exception_middleware.html">Exceptions</a> middleware component will trap and log all exceptions that occur during the API call. There are 2 types of exceptions that will be handled slightly differently: </p><ol>
<li>
<a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_models_1_1_user_exception.html">UserException</a> will record the exception, and send the full message back in the HTTP response </li>
<li>
All others will still record the exception, but will instead send back in the HTTP response a "nice" message: We're sorry, but something went wrong with your request. The details of this issue have been captured - please reference issue #{guid} if you need to contact the help desk. </li>
</ol>
<h1><a class="anchor" id="ApiLoggingMd"></a>
Logging</h1>
<p>The <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_api_logging_middleware.html">Logging</a> middleware will ensure that all API calls are logged. The <a class="el" href="interface_sphyrnidae_1_1_common_1_1_logging_1_1_interfaces_1_1_i_logger.html">logging</a> of these calls will contain both request and response information (eg. the response body and how long it took).</p>
<p>Additionally, the custom sphyrnidae middleware componets ( <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_http_data_middleware.html">HttpData</a>, <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_authentication_middleware.html">Authentication</a>, <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_jwt_middleware.html">JWT</a>, <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_exception_middleware.html">Exceptions</a>, <a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_api_logging_middleware.html">Logging</a>) will all log that the middleware component is executing (starting, and stopping with time elapsed). </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
