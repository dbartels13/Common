<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sphyrnidae Common Library: Encryption</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Sphyrnidae Common Library
   &#160;<span id="projectnumber">2.0.1</span>
   </div>
   <div id="projectbrief">Shared Utilities/Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_encryption_md.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Encryption </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_C__Users_dougb_Desktop_Sphyrnidae_New_Common_Common_Encryption_Encryption"></a> </p>
<h1><a class="anchor" id="EncryptionOverviewMd"></a>
Overview</h1>
<p>Encryption turns a string with valuable information (eg. passwords, credit card numbers, personal information, etc) into an encrypted value. This encrypted value will be meaningless to the hacker unless they have a key to decrypt it, and the correct algorithm to do so. The <a class="el" href="interface_sphyrnidae_1_1_common_1_1_encryption_1_1_i_encryption.html">IEncryption</a> interface defines the methods needed for encryption:</p><ol type="1">
<li>Hash(): Given a string and some hash (string), the implementation will perform 1-way encryption (this CAN NOT be decrypted)</li>
<li>HashMatch(): Allows you to re-hash a string and compare it to a stored hash value (eg. password validation)</li>
<li>Encrypt(): Encrypts a string (2-way)</li>
<li>Decrypt(): Decrypts a string</li>
</ol>
<p>The implementation <a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_encryption_dispatcher.html">EncryptionDispatcher</a> makes everything configurable:</p><ol type="1">
<li><a class="el" href="_encryption_md.html#EncryptionKeysMd">Key lookup</a>: Interface driven capability to retrieve the encryption key</li>
<li><a class="el" href="_encryption_md.html#EncryptionAlgorithmsMd">Encryption Algorithms</a>: Allows you to have multiple algorithms that do all the work</li>
</ol>
<p>Interface: <a class="el" href="interface_sphyrnidae_1_1_common_1_1_encryption_1_1_i_encryption.html">IEncryption</a></p>
<p>Mock: <a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_encryption_none.html">EncryptionNone</a></p>
<p>Implementations:</p><ol type="1">
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_encryption_dispatcher.html">EncryptionDispatcher</a>: Preferred / Default</li>
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_algorithms_1_1_encryption_strong.html">EncryptionStrong</a>: A stronger encryption algorithm, but takes longer to execute</li>
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_algorithms_1_1_encryption_weak.html">EncryptionWeak</a>: A weaker encryption algorithm, but is fast to execute</li>
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_algorithms_1_1_encryption_normal.html">EncryptionNormal</a>: Somewhere inbetween the weak and strong algorithms</li>
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_algorithms_1_1_encryption_old.html">EncryptionOld</a>: My first attempt at encryption. Works fine</li>
</ol>
<p>Wrapper: <a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_encryption_extensions.html">EncryptionExtensions</a> (string extension methods)</p>
<h1><a class="anchor" id="EncryptionDispatcherMd"></a>
Dispatcher</h1>
<p>The preferred implementation of <a class="el" href="interface_sphyrnidae_1_1_common_1_1_encryption_1_1_i_encryption.html">IEncryption</a> is the <a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_encryption_dispatcher.html">EncryptionDispatcher</a>. How this works is that any encryption attempt will use the default key, which will also be linked to a unique identifier. It will also use the default algorithm, which also has a unique identifier. These identifiers will be a part of the final encryption string so that the decryption attempt knows which key and algorithm to use.</p>
<p>This implementation utilizes 2 additional interfaces for it's functionality:</p><ol type="1">
<li><a class="el" href="interface_sphyrnidae_1_1_common_1_1_encryption_1_1_key_manager_1_1_i_encryption_key_manager.html">IEncryptionKeyManager</a>: See <a class="el" href="_encryption_md.html#EncryptionKeysMd">Key lookup</a></li>
<li><a class="el" href="interface_sphyrnidae_1_1_common_1_1_encryption_1_1_algorithms_1_1_i_encryption_algorithms.html">IEncryptionAlgorithms</a>: See <a class="el" href="_encryption_md.html#EncryptionAlgorithmsMd">Encryption Algorithms</a></li>
</ol>
<h1><a class="anchor" id="EncryptionKeysMd"></a>
Key Lookup</h1>
<p>An encryption key is a secret key (usually a string, Base64 string, or byte[]) that you must possess to encrypt or decrypt. Without this key, an encrypted value will be impossible to decrypt. Because of the importance of this key, it must be kept in a secure location such as:</p><ol type="1">
<li>Key Vault Store: Cloud-based service which stores all of your keys securely behind your application firewall. See <a href="https://azure.microsoft.com/en-us/services/key-vault/" target="blank">Azure</a> or <a href="https://aws.amazon.com/kms/" target="blank">AWS</a></li>
<li>Environmental Variable: As long as your application is behind a firewall, a hacker should not be able to get into your application and steal this. If they are able to, you might have larger/other things to worry about.</li>
<li>Source code: In older applications, this was stored directly in web.config. This is generally considered a bad practice, but if you can trust your source code repository, you may still wish to hard-code in these keys directly into your application files.</li>
<li>Others?</li>
</ol>
<p>Which one you choose is completely up to you and your security needs. The end result is that you should have at least 1 key (possibly more), and have an invalidation scheme for these keys.</p>
<p><a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_encryption_dispatcher.html">EncryptionDispatcher</a> will perform lookup of encryption keys via the interface <a class="el" href="interface_sphyrnidae_1_1_common_1_1_encryption_1_1_key_manager_1_1_i_encryption_key_manager.html">IEncryptionKeyManager</a>.</p>
<h1><a class="anchor" id="EncryptionAlgorithmsMd"></a>
Encryption Algorithms</h1>
<p>As with encryption keys, you may wish to have a dynamic set of encryption algorithms in case one of them gets compromised. These algorithms will ultimately inherit from <a class="el" href="interface_sphyrnidae_1_1_common_1_1_encryption_1_1_i_encryption.html">IEncryption</a>, so you could directly register these as an <a class="el" href="interface_sphyrnidae_1_1_common_1_1_encryption_1_1_i_encryption.html">IEncryption</a> implementation. However, it would be better to keep multiple algorithms on-hand and swich as necessary. This will also allow you to decrypt older strings that may have been encrypted using a previous method.</p>
<p>The <a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_encryption_dispatcher.html">EncryptionDispatcher</a> does this utilizing the <a class="el" href="interface_sphyrnidae_1_1_common_1_1_encryption_1_1_algorithms_1_1_i_encryption_algorithms.html">IEncryptionAlgorithms</a> interface. You essentially specify all the possible <a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_algorithms_1_1_encryption_algorithm.html">algorithms</a>, which one is current, and you're off and running.</p>
<p>The default implementation of the <a class="el" href="interface_sphyrnidae_1_1_common_1_1_encryption_1_1_algorithms_1_1_i_encryption_algorithms.html">IEncryptionAlgorithms</a> interface is <a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_algorithms_1_1_sphyrnidae_encryption_algorithms.html">SphyrnidaeEncryptionAlgorithms</a>. This registers the following algorithms:</p><ol type="1">
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_algorithms_1_1_encryption_weak.html">EncryptionWeak</a>: Default algorithm</li>
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_algorithms_1_1_encryption_normal.html">EncryptionNormal</a></li>
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_algorithms_1_1_encryption_strong.html">EncryptionStrong</a></li>
</ol>
<p>If no key is found, the 'void' algorithm is <a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_algorithms_1_1_encryption_old.html">EncryptionOld</a>. You should likely implement your own set of algorithms.</p>
<h1><a class="anchor" id="EncryptionWhereUsedMd"></a>
Where Used</h1>
<ol type="1">
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_authentication_middleware.html">AuthenticationMiddleware</a>: Parsing the JWT</li>
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_api_1_1_middleware_1_1_jwt_middleware.html">JwtMiddleware</a>: Encrypting the JWT to send out in the HTTP response</li>
<li>IdentityHelper: Working with the JWT</li>
<li>IdentityWrapper: Getting or setting the Identity object</li>
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_email_utilities_1_1_dot_net_email.html">DotNetEmail</a>: Decrypting the <a class="el" href="interface_sphyrnidae_1_1_common_1_1_email_utilities_1_1_interfaces_1_1_i_dot_net_email_settings.html#a2ee5893458a720cafbe40576e98b94cd">Password</a></li>
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_encryption_1_1_encryption_extensions.html">EncryptionExtensions</a>: Extension method you should use when doing any encryption activities</li>
<li>LogRepo: Decrypting the connection string for the logging repository</li>
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_web_services_1_1_web_service_base.html">WebServiceBase</a>: The JWT will be included in all web service requests</li>
</ol>
<h1><a class="anchor" id="EncryptionExampleMd"></a>
Examples</h1>
<pre>
    //
    // Registering your own algorithm(s)
    //

    // Create the algorithm (Note this is not using the key mangaer)
    public class MyEncryptionAlgorithm : EncryptionAlgorithm
    {
        private IEncryptionKeyManager KeyManager { get; set; }
        public MyEncryptionAlgorithm(IEncryptionKeyManager keyManager) =&gt; KeyManager = keyManager;

        public override string Id =&gt; "my unique algorithm id";
        public override DecryptionResponse Decrypt(string str) =&gt; new DecryptionResponse { IsCurrent = true, Value = "decrypted value" };
        public override string Encrypt(string str) =&gt; "Encrypted Value";
        public override byte[] Hash(string str, string salt) =&gt; new byte[0];
    }

    // Create registration class
    public class MyEncryptionAlgorithms : SphyrnidaeEncryptionAlgorithms
    {
        public MyEncryptionAlgorithms(IEncryptionKeyManager manager) : base(manager) { }

        public override List&lt;EncryptionAlgorithm&gt; All =&gt; new List&lt;EncryptionAlgorithm&gt; { Current };
        public override EncryptionAlgorithm Current =&gt; new MyEncryptionAlgorithm(Manager);
        public override EncryptionAlgorithm Void =&gt; Current;
    }

    // Update service registration (startup.cs)
    services.Transient&lt;IEncryptionAlgorithms, MyEncryptionAlgorithms&gt;();


    //
    // Custom Key Manager
    //

    // Create the key manager
    public class MyKeyManager : IEncryptionKeyManager
    {
        // Will want to look these up from a key vault
        public EncryptionKey CurrentKey =&gt; new EncryptionKey { Id = "my key identifier", Key = "my encryption key", IsCurrent = true };
        public FoundEncryptionKey GetKeyFromString(string encrypted)
        {
            if (!encrypted.StartsWith(CurrentKey.Id)) // May look for other keys in the key vault that match
                throw new Exception("Unable to locate matching encryption key");
            return new FoundEncryptionKey(CurrentKey, encrypted);
        }
    }

    // Update service registration (startup.cs)
    services.Transient&lt;IEncryptionKeyManager, MyKeyManager&gt;();


    //
    // Performing Encryption
    //
    IEncryption encryption; // Should be injected
    var myVal = "string to encrypt";
    var encrypted = myVal.Encrypt(encryption);
    var decrypted = encrypted.Decrypt(encryption);
    if (string.IsNullOrWhiteSpace(decrypted.Value))
        throw new Exception("Unable to decrypt");
    if (!decrypted.IsCurrent)
        var updatedEncryption = decrypted.Value.Encrypt(encryption); // Store this back into your repository with latest method
    return decrypted.Value;
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
