<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sphyrnidae Common Library: Dynamic SQL</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Sphyrnidae Common Library
   &#160;<span id="projectnumber">2.0.1</span>
   </div>
   <div id="projectbrief">Shared Utilities/Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_dynamic_sql_md.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Dynamic SQL </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_C__Users_dougb_Desktop_Sphyrnidae_New_Common_Common_DynamicSql_DynamicSql"></a> </p>
<h1><a class="anchor" id="DynamicSqlOverviewMd"></a>
Overview</h1>
<p>If you don't want to fully create your own sql statement, or your sql will be somewhat dynamic in nature, this class can help. There are 2 main components to this:</p><ol type="1">
<li><a class="el" href="_dynamic_sql_md.html#DynamicSqlBuilderMd">Dynamic Sql Generation</a>: This class utilizes the builder pattern to generate the complete SQL statement</li>
<li><a class="el" href="_dynamic_sql_md.html#DynamicSqlExecuteMd">Executing Sql</a>: Allows for generic execution of the generated SQL</li>
</ol>
<p>If the SQL you wish to generate is known at design-time, then you should just directly generate that SQL (possibly as a Stored Procedure). However, if you are dynamically building the SQL with various tables and columns that could change, then this is the tool for now. A common scenario for this would be in report building where the user can specify which tables, columns, aggregates, ordering, etc.</p>
<h1><a class="anchor" id="DynamicSqlBuilderMd"></a>
Generating Dynamic Sql Object</h1>
<h2>Getting Started</h2>
<p>You will begin by specifing the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_table.html">Primary Table</a>. All you need to specify initially is the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_table.html#a35673dd3f81d119592917dc116c7474e">Name</a> of the table. From there, you can utilize the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_dynamic_sql_builder.html">DynamicSqlBuilder</a>. The constructor will take the primary table you've created as the sole argument.</p>
<p>From here, you can either add <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_column.html">columns</a> to the table directly, or you can utilize the AddColumn() method on the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_dynamic_sql_builder.html">DynamicSqlBuilder</a>. You must at a minimum specify the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_column.html#aeb293d95af8e1ae7b38654fa8265433a">Name</a>. You will need to specify at least 1 column as <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_column.html#a709284baf8e8f6267ce01acf62e95a72">IsSelect</a>. On the column itself, you can also specify this column as <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_column.html#a9527d344efc06769bf593ac1fa68160f">grouping</a>, as an <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_aggregate_specification.html">aggregate</a> (it can actually be aggregated multiple ways), or if it is involved in <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_column.html#a6518e3a4e58a22c75d707f4ce25259cc">ordering</a>. If you have multiple <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_column.html#a6518e3a4e58a22c75d707f4ce25259cc">ordering</a> columns, you should also specify the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_column.html#ac9746065659db1a70491b82eb237005e">priority</a>.</p>
<h2>Join Tables</h2>
<p>To have multiple tables in your SQL, you will create another table as a <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_join_table.html">Join Table</a>. This table is just like your primary table - so you need only specify the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_table.html#a35673dd3f81d119592917dc116c7474e">Name</a> of the table. By default, this table will be <a class="el" href="namespace_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_enums.html#a983c0411ac10c03ecaafb6dbb2ebf922">joined</a> by an <a class="el" href="namespace_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_enums.html#a983c0411ac10c03ecaafb6dbb2ebf922aa1684698ac3d8ffda353d0458c30b1e7">inner join</a>. You can update this join to be other types. You can then call the AddTable() method on the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_dynamic_sql_builder.html">DynamicSqlBuilder</a>. You can add columns the same way to this table as you did for the primary table (any calls to AddColumn() will be against the last table specified in the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_dynamic_sql_builder.html">DynamicSqlBuilder</a>).</p>
<p>In order to specify the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html">join condition</a> for this table, you should create a condition (see below), and then call AddCondition() method on the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_dynamic_sql_builder.html">DynamicSqlBuilder</a>. As with columns, the conditions will apply to the latest table specified.</p>
<h2>Conditions</h2>
<p>A <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html">Condition</a> can be added to the 'Where' clause to filter results. These same conditions are also used for join conditions when joining multiple tables together in your 'From' clause. To add conditions to your 'Where' clause, you should first call the BeginWhere() method on the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_dynamic_sql_builder.html">DynamicSqlBuilder</a>. From there, you can begin adding conditions. The first condition you add will appear immediately after the 'Where' clause. For subsequent conditions, these will be siblings of the previous condition, and you must specify how the conditions are <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html#adce6064cf249e1a578e00b3e8f3ec771">joined</a> together. Default join condition is <a class="el" href="namespace_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_enums.html#a1c583b7ca71c1e58b90625391a96cdf5ac33315685a0cba3ce53be378b3c7874b">And</a>.</p>
<p>A condition will have the following properties:</p><ol type="1">
<li>Left operand: The <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html#aa9840cb376f92591d0b670702196cd42">Left Column</a> will be one of the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_column.html">Columns</a> that belongs to a table</li>
<li>Operator: The <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html#a6933809c4970d1133d612a38174756bf">Operator</a> will be one of the <a class="el" href="namespace_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_enums.html#a5ddb3287d19fa442ef30117aa5cf8d48">Compare Operators</a></li>
<li>Right operand: This will either a <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html#afa765918d3b6379044a91c4822173f9f">Right Column</a> or a <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html#a850ffaaac509a83ecf1b9fbb7240d090">Right Value</a></li>
</ol>
<p>If you are specifying a non-column, this will be of type <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html#a850ffaaac509a83ecf1b9fbb7240d090">Right Value</a>. The value you specify will be parameterized in your SQL. Note that some <a class="el" href="namespace_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_enums.html#a5ddb3287d19fa442ef30117aa5cf8d48">Compare Operators</a> take multiple values. For these types, you should specify the 2nd (or any subsequent) parameters in <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html#a4e64d819a655e07904d1d93551a51184">AdditionalParameterValues</a>. Here is the listing of <a class="el" href="namespace_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_enums.html#a5ddb3287d19fa442ef30117aa5cf8d48">Compare Operators</a> where this is required:</p><ol type="1">
<li><a class="el" href="namespace_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_enums.html#a5ddb3287d19fa442ef30117aa5cf8d48aefeb369cccbd560588a756610865664c">In</a>: You will not specify a <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html#a850ffaaac509a83ecf1b9fbb7240d090">Right Value</a> at all. All possible values should be added to <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html#a4e64d819a655e07904d1d93551a51184">AdditionalParameterValues</a></li>
<li><a class="el" href="namespace_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_enums.html#a5ddb3287d19fa442ef30117aa5cf8d48a74756e506e244720ace229ac149467f3">DateRange</a>: You will specify the first date as the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html#a850ffaaac509a83ecf1b9fbb7240d090">Right Value</a>. The 2nd date shoule be added to <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html#a4e64d819a655e07904d1d93551a51184">AdditionalParameterValues</a></li>
</ol>
<p>If you need to group conditions together - eg. to specify AND (A OR B) - you can utilize the BeginGroup() method on the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_dynamic_sql_builder.html">DynamicSqlBuilder</a> which will essentially write out "AND (". You can then add additional conditions to the grouping. The first condition added will not have the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_condition.html#adce6064cf249e1a578e00b3e8f3ec771">join</a> condition specified. When you are done adding conditions to the group, you will call the EndGroup() method on the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_dynamic_sql_builder.html">DynamicSqlBuilder</a> which will essentially write out "AND (", which will essentially write out the ")". You can also nest groupings (eg. a grouping within a grouping).</p>
<h2>Limitations</h2>
<p>This class is not meant to be all-inclusive of all possible SQL statements and structures. Only the methods documented are currently supported. If you need other functionality, a change request can be made to add that piece of functionality.</p>
<h2>Build</h2>
<p>When you are done adding everything to the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_dynamic_sql_builder.html">DynamicSqlBuilder</a>, you will call the Build() method which will validate everything and return a <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_dynamic_sql.html">DynamicSql</a> object. If the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_dynamic_sql.html#aa48dda1910fd9b8d9f6f41e90b005f24">Error</a> property is populated, then validation failed with the specified message. Otherwise, the <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_dynamic_sql.html#a18afb0c6832f12ed977f790676f22df7">generated SQL</a> and <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_dynamic_sql.html#a5649166662d10dea03eb41896be0860a">parameters</a> will be populated.</p>
<h1><a class="anchor" id="DynamicSqlExecuteMd"></a>
Executing Sql</h1>
<p>Once you have built the sql object (see above), you now will likely want to execute that SQL. There is no need to build your own repository (see <a class="el" href="_dal_md.html">Data Access Layer</a>), as a generic repository is available for use:</p><ol type="1">
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_dynamic_sql_server_repo.html">DynamicSqlServerRepo</a> for executing against a SQL Server database</li>
<li><a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_dynamic_my_sql_repo.html">DynamicMySqlRepo</a></li>
</ol>
<p>To use these classes, use dependency injection to inject the instances, and then call whatever method you would like:</p><ol type="1">
<li>List: Retrieves multiple rows</li>
<li>Get: Retreives a single row</li>
<li>Scalar: Retrieves a single column from a single row</li>
</ol>
<p>The parameters to these functions are:</p><ol type="1">
<li>The Connection String</li>
<li>SQL: The SQL to execute (from <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_dynamic_sql.html#a18afb0c6832f12ed977f790676f22df7">sql</a>)</li>
<li>Parameters: The parameters needed for the query (from <a class="el" href="class_sphyrnidae_1_1_common_1_1_dynamic_sql_1_1_models_1_1_dynamic_sql.html#a5649166662d10dea03eb41896be0860a">parameters</a>)</li>
</ol>
<h1><a class="anchor" id="DynamicSqlWhereUsedMd"></a>
Where Used</h1>
<p>None</p>
<h1><a class="anchor" id="DynamicSqlExampleMd"></a>
Examples</h1>
<pre>
To generate the following SQL:
    SELECT
        Count([tbl1].[RoleId]) AS [NumRoles],
        [tbl0].[UserId] AS [UserId]
    FROM
        [Users] AS [tbl0]
        Left JOIN [UserRoles] AS [tbl1]
            ON [tbl0].[UserId] = [tbl1].[UserId]
    WHERE
        [tbl0].[UserId] &lt;= @Param0 And
        (
            [tbl0].[Name] = @Param1
            Or [tbl0].[Name] = @Param2
        )
    GROUP BY
        [tbl0].[UserId]
    ORDER BY
        [tbl0].[Name] Asc

With the following parameters:
    [
        {"Key":"Param0","Value":100},
        {"Key":"Param1","Value":"me"},
        {"Key":"Param2","Value":"you"}
    ]

You can write the following code:
    var usersTable = new Table { Name = "Users" };
    var usersUserId = new Column
    {
        Name = "UserId",
        IsSelect = true,
        IsGrouping = true
    };
    var usersName = new Column
    {
        Name = "Name",
        OrderBy = OrderDirection.Asc
    };

    var userRolesTable = new JoinTable { Name = "UserRoles", Type = JoinType.Left };
    var userRolesUserId = new Column { Name = "UserId" };
    var userRolesRoleId = new Column { Name = "RoleId"};
    userRolesRoleId.Aggregates.Add(
        new AggregateSpecification
        {
            Aggregate = Aggregate.Count,
            Alias = "NumRoles"
        });


    var sqlBuilder = new DynamicSqlBuilder(usersTable);
    sqlBuilder.AddColumn(usersUserId);
    sqlBuilder.AddColumn(usersName);

    sqlBuilder.AddTable(userRolesTable);
    sqlBuilder.AddColumn(userRolesUserId);
    sqlBuilder.AddColumn(userRolesRoleId);
    sqlBuilder.AddCondition(new Condition
    {
        LeftColumn = usersUserId,
        Operator = CompareOperator.Equals,
        RightColumn = userRolesUserId
    });
    sqlBuilder.BeginWhere();
    sqlBuilder.AddCondition(new Condition
    {
        LeftColumn = usersUserId,
        Operator = CompareOperator.LessThanOrEqual,
        RightValue = 100
    });
    sqlBuilder.BeginGroup(ConditionJoin.And);
    sqlBuilder.AddCondition(new Condition
    {
        LeftColumn = usersName,
        Operator = CompareOperator.Equals,
        RightValue = "me"
    });
    sqlBuilder.AddCondition(new Condition
    {
        Join = ConditionJoin.Or,
        LeftColumn = usersName,
        Operator = CompareOperator.Equals,
        RightValue = "you"
    });
    sqlBuilder.EndGroup();

    var sql = sqlBuilder.Build(SqlType.SqlServer);
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
